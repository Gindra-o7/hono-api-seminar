generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum JenisJadwal {
  SEMKP
  SEMPRO
  SEMHAS_LAPORAN
  SEMHAS_PAPERBASED
  SIDANG_TA_LAPORAN
  SIDANG_TA_PAPERBASED
}

model dosen {
  nip               String  @id(map: "pk_nip_dosen") @db.VarChar(18)
  nama              String  @db.VarChar(255)
  email             String  @unique @db.VarChar(255)
  no_hp             String? @unique @db.VarChar(14)
  username_telegram String? @unique @db.VarChar(255)
  id_telegram       String? @unique @db.VarChar(255)

  // Relasi untuk mahasiswa PA
  nipSebagaiMahasiswaPA mahasiswa[] @relation("MahasiswaPA")

  // Relasi untuk dosen penilai
  nipSebagaiDosenPenilai penilaian[] @relation("Penilai")

  // Relasi untuk berbagai peran dalam jadwal  
  jadwalSebagaiPembimbing1 jadwal[] @relation("Pembimbing1")
  jadwalSebagaiPembimbing2 jadwal[] @relation("Pembimbing2")
  jadwalSebagaiPenguji1    jadwal[] @relation("Penguji1")
  jadwalSebagaiPenguji2    jadwal[] @relation("Penguji2")
  jadwalSebagaiKetuaSidang jadwal[] @relation("KetuaSidang")

  // Relasi untuk absensi (dosen sebagai approver)
  absensiSebagaiApprover absensi[] @relation("DosenApprover")
}

model mahasiswa {
  nim   String  @id(map: "pk_nim_mahasiswa") @db.VarChar(11)
  nama  String  @db.VarChar(255)
  aktif Boolean @default(true)
  email String  @unique @db.VarChar(36)

  nip   String @db.VarChar(18)
  dosen dosen  @relation("MahasiswaPA", fields: [nip], references: [nip], onDelete: NoAction, onUpdate: Cascade, map: "fk_nip_mahasiswa")
  
  absensi absensi[] @relation("MahasiswaAbsensi")
  jadwal jadwal[] @relation("JadwalMahasiswa")
}

model ruangan {
  kode   String  @id(map: "pk_kode_ruangan") @db.VarChar(10)
  nama   String  @db.VarChar(50)
  status Boolean @default(true) @db.Boolean

  jadwal jadwal[] @relation("JadwalRuangan")
}

model jadwal {
  id            String      @id(map: "pk_id_jadwal") @db.VarChar(14)
  tanggal       DateTime    @db.Date
  waktu_mulai   DateTime    @db.Timestamptz
  waktu_selesai DateTime    @db.Timestamptz
  jenis         JenisJadwal

  // Relasi dengan Mahasiswa
  nim       String    @db.VarChar(11)
  mahasiswa mahasiswa @relation("JadwalMahasiswa", fields: [nim], references: [nim], onDelete: NoAction, onUpdate: Cascade, map: "fk_nim_mahasiswa")

  // Relasi dengan Ruangan
  kode_ruangan String  @db.VarChar(10)
  ruangan      ruangan @relation("JadwalRuangan", fields: [kode_ruangan], references: [kode], onDelete: NoAction, onUpdate: Cascade, map: "fk_kode_ruangan")

  // Relasi dengan Dosen sebagai Pembimbing 1
  nip_pembimbing_1 String @db.VarChar(18)
  pembimbing_1     dosen  @relation("Pembimbing1", fields: [nip_pembimbing_1], references: [nip], onDelete: NoAction, onUpdate: Cascade, map: "fk_nip_pembimbing_1")

  // Relasi dengan dosen sebagai Pembimbing 2 (Opsional)
  nip_pembimbing_2 String? @db.VarChar(18)
  pembimbing_2     dosen?  @relation("Pembimbing2", fields: [nip_pembimbing_2], references: [nip], onDelete: NoAction, onUpdate: Cascade, map: "fk_nip_pembimbing_2")

  // Relasi dengan dosen sebagai Penguji 1
  nip_penguji_1 String @db.VarChar(18)
  penguji_1     dosen  @relation("Penguji1", fields: [nip_penguji_1], references: [nip], onDelete: NoAction, onUpdate: Cascade, map: "fk_nip_penguji_1")

  // Relasi dengan dosen sebagai Penguji 2 (Opsional)
  nip_penguji_2 String? @db.VarChar(18)
  penguji_2     dosen?  @relation("Penguji2", fields: [nip_penguji_2], references: [nip], onDelete: NoAction, onUpdate: Cascade, map: "fk_nip_penguji_2")

  // Relasi dengan dosen sebagai Ketua Sidang
  nip_ketua_sidang String? @db.VarChar(18)
  ketua_sidang     dosen?  @relation("KetuaSidang", fields: [nip_ketua_sidang], references: [nip], onDelete: NoAction, onUpdate: Cascade, map: "fk_nip_ketua_sidang")

  // Relasi dengan Penilaian
  penilaian penilaian[] @relation("PenilaianJadwal")

  // Relasi dengan Absensi
  absensi absensi[] @relation("AbsensiJadwal")

  // Relasi dengan Tahun Ajaran
  kode_tahun_ajaran String @db.VarChar(5)
}

model komponen_penilaian {
  id         String                   @id(map: "pk_id_komponen_penilaian") @db.VarChar(7)
  nama       String                   @db.VarChar(50)
  persentase Int                      @db.Integer
  is_aktif   Boolean                  @db.Boolean
  penilai    PenilaiKomponenPenilaian
}

enum PenilaiKomponenPenilaian {
  // role penilai kerja praktik
  KP_INSTANSI
  KP_PEMBIMBING
  KP_PENGUJI

  // role penilai tugas akhir
  TA_PEMBIMBING_1
  TA_PEMBIMBING_2
  TA_PENGUJI_1
  TA_PENGUJI_2
  TA_KETUA_SIDANG
}

model penilaian {
  id_jadwal             String @db.VarChar(14)
  nilai                 Json

  // Foreign Key ke dosen
  nip       String @db.VarChar(18)
  nip_dosen dosen  @relation("Penilai", fields: [nip], references: [nip], onDelete: NoAction, onUpdate: Cascade)

  // Relasi dengan Jadwal
  jadwal jadwal @relation("PenilaianJadwal", fields: [id_jadwal], references: [id], onDelete: NoAction, onUpdate: Cascade)

  // Definisikan composite primary key di sini
  @@id([id_jadwal], map: "pk_penilaian")
}

enum LogActionType {
  CREATE
  UPDATE
  DELETE
}

enum LogActorType {
  KOORDINATOR
  DOSEN
  MAHASISWA
}

// Model untuk mencatat log perubahan pada JADWAL
model log_jadwal {
  id        String    @id @default(cuid())
  timestamp DateTime  @default(now())
  action    LogActionType

  // Siapa yang melakukan perubahan
  actor_type LogActorType
  actor_id   String

  // ID dari jadwal yang berubah
  jadwal_id String

  // Data lama dan data baru disimpan sebagai JSON
  // 'old_values' kosong saat CREATE
  // 'new_values' kosong saat DELETE
  old_values Json?
  new_values Json?

  @@index([jadwal_id])
  @@index([actor_id])
}

// Model untuk mencatat log perubahan pada PENILAIAN
model log_penilaian {
  id        String    @id @default(cuid())
  timestamp DateTime  @default(now())
  action    LogActionType

  // Siapa yang melakukan perubahan
  actor_type LogActorType
  actor_id   String // NIP Dosen yang memberi/mengubah nilai

  // Kunci komposit dari tabel penilaian
  id_jadwal             String
  id_komponen_penilaian String
  
  // Karena 'penilaian' sederhana (hanya 'nilai'),
  // kita bisa catat nilainya secara langsung
  old_nilai Int?
  new_nilai Int?

  @@index([id_jadwal])
  @@index([actor_id])
}

enum StatusAbsensi {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model absensi {
  id              String         @id(map: "pk_id_absensi") @default(cuid())
  status          StatusAbsensi  @default(PENDING)
  catatan_mhs     String?        @db.Text // Catatan dari mahasiswa saat submit
  catatan_reject  String?        @db.Text // Alasan reject dari dosen
  tanda_tangan    String?        @db.Text // Base64 atau URL tanda tangan digital
  waktu_submit    DateTime       @default(now()) @db.Timestamptz
  waktu_approved  DateTime?      @db.Timestamptz
  waktu_rejected  DateTime?      @db.Timestamptz
  waktu_cancelled DateTime?      @db.Timestamptz

  // Foreign Key ke jadwal (seminar yang dihadiri)
  id_jadwal String @db.VarChar(14)
  jadwal    jadwal @relation("AbsensiJadwal", fields: [id_jadwal], references: [id], onDelete: Cascade, onUpdate: Cascade, map: "fk_id_jadwal_absensi")

  // Foreign Key ke mahasiswa (yang hadir)
  nim       String    @db.VarChar(11)
  mahasiswa mahasiswa @relation("MahasiswaAbsensi", fields: [nim], references: [nim], onDelete: Cascade, onUpdate: Cascade, map: "fk_nim_mahasiswa_absensi")

  // Foreign Key ke dosen (yang approve/reject)
  nip_approver String? @db.VarChar(18)
  dosen        dosen?  @relation("DosenApprover", fields: [nip_approver], references: [nip], onDelete: NoAction, onUpdate: Cascade, map: "fk_nip_dosen_approver")

  // Relasi dengan Log Absensi
  log_absensi log_absensi[]

  // Constraint: Satu mahasiswa hanya bisa absen sekali per jadwal
  @@unique([id_jadwal, nim], map: "unique_absensi_jadwal_mahasiswa")
  @@index([id_jadwal], map: "idx_absensi_jadwal")
  @@index([nim], map: "idx_absensi_mahasiswa")
  @@index([status], map: "idx_absensi_status")
  @@index([nip_approver], map: "idx_absensi_approver")
}

model log_absensi {
  id        String        @id @default(cuid())
  timestamp DateTime      @default(now()) @db.Timestamptz
  action    LogActionType

  // Siapa yang melakukan perubahan
  actor_type LogActorType
  actor_id   String // NIM mahasiswa atau NIP dosen

  // ID dari absensi yang berubah
  id_absensi String
  absensi    absensi @relation(fields: [id_absensi], references: [id], onDelete: Cascade, onUpdate: Cascade, map: "fk_id_absensi_log")

  // Data lama dan data baru disimpan sebagai JSON
  // Contoh: {"status": "PENDING", "catatan": "..."}
  old_values Json?
  new_values Json?

  @@index([id_absensi], map: "idx_log_absensi_id")
  @@index([actor_id], map: "idx_log_absensi_actor")
  @@index([timestamp], map: "idx_log_absensi_timestamp")
}