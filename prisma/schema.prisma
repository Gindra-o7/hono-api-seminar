generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum JenisJadwal {
  SEMKP
  SEMPRO
  SEMHAS_LAPORAN
  SEMHAS_PAPERBASED
  SIDANG_TA_LAPORAN
  SIDANG_TA_PAPERBASED
}

enum PenilaiRole {
  KP_INSTANSI
  KP_PEMBIMBING
  KP_PENGUJI
  TA_PEMBIMBING_1
  TA_PEMBIMBING_2
  TA_PENGUJI_1
  TA_PENGUJI_2
  TA_KETUA_SIDANG
}

enum LogActionType {
  CREATE
  UPDATE
  DELETE
}

enum LogActorType {
  KOORDINATOR
  DOSEN
  MAHASISWA
}

model dosen {
  nip    String @id @db.VarChar(18)
  nama   String @db.VarChar(255)
  email  String @unique @db.VarChar(255)
  no_hp  String? @unique @db.VarChar(14)

  penilaian penilaian[]
}


model mahasiswa {
  nim    String @id @db.VarChar(11)
  nama   String @db.VarChar(255)
  email  String @unique @db.VarChar(36)
  aktif  Boolean @default(true)

  jadwal jadwal[]
}

model ruangan {
  kode   String @id @db.VarChar(10)
  nama   String @db.VarChar(50)
  status Boolean @default(true) @db.Boolean

  jadwal jadwal[]
}

model jadwal {
  id            String   @id @db.VarChar(14)
  tanggal       DateTime @db.Timestamptz
  waktu_mulai   DateTime @db.Timestamptz
  waktu_selesai DateTime @db.Timestamptz
  jenis         JenisJadwal

  nim String
  mahasiswa mahasiswa @relation(fields: [nim], references: [nim])

  kode_ruangan String
  ruangan ruangan @relation(fields: [kode_ruangan], references: [kode])

  kode_tahun_ajaran String @db.VarChar(5)

  penilaian penilaian[]

  @@index([tanggal])
}


model komponen_penilaian {
  id         String  @id @db.VarChar(7)
  nama       String  @db.VarChar(50)
  persentase Int
  is_aktif   Boolean @default(true)
  role       PenilaiRole

  detail_penilaian detail_penilaian[]
}

model penilaian {
  id        String @id @default(cuid())
  id_jadwal String
  nip       String
  role      PenilaiRole

  jadwal jadwal @relation(fields: [id_jadwal], references: [id])
  dosen  dosen  @relation(fields: [nip], references: [nip])

  detail_penilaian detail_penilaian[]

  @@unique([id_jadwal, nip])
  @@index([id_jadwal])
  @@index([nip])
}

model detail_penilaian {
  id              String @id @default(cuid())
  id_penilaian    String
  id_komponen     String
  nilai           Float

  penilaian penilaian @relation(fields: [id_penilaian], references: [id], onDelete: Cascade)
  komponen  komponen_penilaian @relation(fields: [id_komponen], references: [id])

  @@unique([id_penilaian, id_komponen])
  @@index([id_komponen])
}

model log_jadwal {
  id        String    @id @default(cuid())
  timestamp DateTime  @default(now()) @db.Timestamptz()
  action    LogActionType

  actor_type LogActorType
  actor_id   String

  jadwal_id String

  old_values Json?
  new_values Json?

  @@index([jadwal_id])
  @@index([actor_id])
}

model log_penilaian {
  id        String    @id @default(cuid())
  timestamp DateTime  @default(now()) @db.Timestamptz()
  action    LogActionType

  actor_type LogActorType
  actor_id   String

  id_jadwal             String
  id_komponen_penilaian String
  
  old_nilai Int?
  new_nilai Int?

  @@index([id_jadwal])
  @@index([actor_id])
}